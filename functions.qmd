---
title: "Browse by function"
execute:
  echo: false
  message: false
  warning: false
---
Search the table below (use the filters at the top of each column) to find LD clusters associated with functional annotations.

```{r}
library(tidyverse)
library(DT)
library(htmltools)

meta <- readr::read_csv("data/clusters_metadata.csv", show_col_types = FALSE) %>%
  mutate(
    cluster_id = as.character(cluster_id),
    cluster_page = paste0("clusters/cluster_", cluster_id, ".html")
  )

# ----------------------------
# GO annotations
# ----------------------------
ann_raw <- readr::read_csv("data/GO_annotation.csv", show_col_types = FALSE)

# Normalize column names (handles spaces + capitalization)
ann <- ann_raw %>%
  rename_with(~ gsub("[^A-Za-z0-9]+", "_", .x)) %>%   # spaces -> underscores
  rename_with(tolower) %>%                            # lower-case
  mutate(cluster_id = as.character(cluster_id))

needed <- c(
  "cluster_id", 
  "n_go_annotated_proteins", 
  "biological_process", 
  "cellular_component", 
  "molecular_function", 
  "gene_descriptions"
)

missing_cols <- setdiff(needed, names(ann))
if (length(missing_cols) > 0) {
  stop("data/GO_annotation.csv is missing required columns: ",
       paste(missing_cols, collapse = ", "))
}

cluster_fun <- ann %>%
  transmute(
    cluster_id,
    n_annotated_rows = as.integer(n_go_annotated_proteins),
    Gene_Descriptions = na_if(trimws(gene_descriptions), ""),
    Biological_Processes = na_if(trimws(biological_process), ""),
    Molecular_Functions  = na_if(trimws(molecular_function), ""),
    Cellular_Components  = na_if(trimws(cellular_component), "")
  )

# ----------------------------
# Join to meta and build browse table
# ----------------------------
tbl <- meta %>%
  left_join(cluster_fun, by = "cluster_id") %>%
  mutate(
    n_annotated_rows = replace_na(n_annotated_rows, 0),
    Cluster = sprintf('<a href="%s">%s</a>', cluster_page, cluster_id)
  ) %>%
  select(
    Scaffold = scaffold,
    Cluster,
    `Start (bp)` = start_bp,
    `End (bp)` = end_bp,
    `# SNPs` = n_snps,
    `# GO-annotated proteins` = n_annotated_rows,
    `Molecular function` = Molecular_Functions,
    `Biological process` = Biological_Processes,
    `Cellular component` = Cellular_Components,
    `Gene descriptions` = Gene_Descriptions
  )

truncate_with_tooltip <- function(x, n = 80) {
  x <- ifelse(is.na(x), "", x)
  short <- ifelse(nchar(x) > n, paste0(substr(x, 1, n), "â€¦"), x)
  sprintf('<span title="%s">%s</span>', htmlEscape(x), htmlEscape(short))
}

tbl <- tbl %>%
  mutate(
    `Molecular function` = truncate_with_tooltip(`Molecular function`, 70),
    `Biological process` = truncate_with_tooltip(`Biological process`, 70),
    `Cellular component` = truncate_with_tooltip(`Cellular component`, 50),
    `Gene descriptions`  = truncate_with_tooltip(`Gene descriptions`, 90)
  )

DT::datatable(
  tbl,
  escape = FALSE,
  rownames = FALSE,
  filter = "top",
  options = list(
    pageLength = 25,
    scrollX = TRUE,
    autoWidth = TRUE,
    columnDefs = list(
      list(
        className = "dt-center",
        targets = 2:5
      )
    )  
  )
)
```
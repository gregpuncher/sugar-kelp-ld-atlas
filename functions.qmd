---
title: "Browse by function"
execute:
  echo: false
  message: false
  warning: false
---
Search the table below (use the filters at the top of each column) to find LD clusters associated with functional annotations.



```{r}
library(tidyverse)
library(DT)

meta <- readr::read_csv("data/clusters_metadata.csv", show_col_types = FALSE) %>%
  mutate(
    cluster_id = as.character(cluster_id),
    cluster_page = paste0("clusters/cluster_", cluster_id, ".html")
  )

# ----------------------------
# SNP annotations (NEW schema)
# ----------------------------
ann_raw <- readr::read_csv("data/snp_annotations.csv", show_col_types = FALSE)

# Normalize column names (handles spaces + capitalization)
ann <- ann_raw %>%
  rename_with(~ gsub("[^A-Za-z0-9]+", "_", .x)) %>%   # spaces -> underscores
  rename_with(tolower) %>%                            # lower-case
  mutate(cluster_id = as.character(cluster_id))

# Expected (after normalization):
# cluster_id
# functional_gene_descriptions
# biological_process
# molecular_function
# cellular_component
# comments

needed <- c("cluster_id", "functional_gene_descriptions", "biological_process",
            "molecular_function", "cellular_component", "comments")
missing_cols <- setdiff(needed, names(ann))
if (length(missing_cols) > 0) {
  stop("data/snp_annotations.csv is missing required columns: ",
       paste(missing_cols, collapse = ", "))
}

# Clean strings
ann <- ann %>%
  mutate(
    functional_gene_descriptions = na_if(trimws(functional_gene_descriptions), ""),
    biological_process           = na_if(trimws(biological_process), ""),
    molecular_function           = na_if(trimws(molecular_function), ""),
    cellular_component           = na_if(trimws(cellular_component), ""),
    comments                     = na_if(trimws(comments), "")
  )

# ----------------------------
# Summarise annotations per cluster
# ----------------------------
cluster_fun <- ann %>%
  group_by(cluster_id) %>%
  summarise(
    n_annotated_rows = n(),
    gene_descriptions = paste(sort(unique(na.omit(functional_gene_descriptions))), collapse = "; "),
    biological_processes = paste(sort(unique(na.omit(biological_process))), collapse = "; "),
    molecular_functions  = paste(sort(unique(na.omit(molecular_function))), collapse = "; "),
    cellular_components  = paste(sort(unique(na.omit(cellular_component))), collapse = "; "),
    comments = paste(sort(unique(na.omit(comments))), collapse = "; "),
    .groups = "drop"
  )

# ----------------------------
# Join to meta and build browse table
# ----------------------------
tbl <- meta %>%
  left_join(cluster_fun, by = "cluster_id") %>%
  mutate(
    n_annotated_rows = replace_na(n_annotated_rows, 0),
    Cluster = sprintf('<a href="%s">%s</a>', cluster_page, cluster_id)
  ) %>%
  select(
    Scaffold = scaffold,
    Cluster,
    `Start (bp)` = start_bp,
    `End (bp)` = end_bp,
    `# SNPs` = n_snps,
    `# annotations` = n_annotated_rows,
    `Molecular function` = molecular_functions,
    `Biological process` = biological_processes,
    `Cellular component` = cellular_components,
    `Gene descriptions` = gene_descriptions,
    `Comments` = comments
  )

DT::datatable(
  tbl,
  escape = FALSE,
  rownames = FALSE,
  filter = "top",
  options = list(
    pageLength = 25,
    scrollX = TRUE,
    autoWidth = TRUE
  )
)
```